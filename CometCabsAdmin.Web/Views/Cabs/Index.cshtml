@model CometCabsAdmin.Web.Models.CabViewModel

@{
    ViewBag.Title = "Manage Cabs";
}
<div class="hidden" id="cabTable">
    @Html.Raw(Json.Encode(Model.CabTable))
</div>

<h2>@ViewBag.Title</h2>
<div id="scope" ng-controller="CabController">
    <div class="row">
        <div class="col-md-1">
            <ul class="nav nav-pills" style="width: 100px;">
                <li role="presentation">
                    <a href="javascript:void(0)" ng-click="addCab()">Add Cab</a>
                </li>
            </ul>
        </div>
        <div class="col-md-8" style="padding-left: 0px;">
            <div class="panel panel-default">
                <!-- Default panel contents -->
                <div class="panel-heading">List of Cabs</div>
                <div class="panel-body">
                    <table class="table table-striped table-hover table-condensed">
                        <thead>
                            <tr>
                                <th>
                                    No.
                                </th>
                                <th>
                                    Cab Code
                                </th>
                                <th>
                                    Max Capacity
                                </th>
                                <th>
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="cab in cabTable" ng-click="editUser(cab)">
                                <td>{{ $index + 1 }}</td>
                                <td>{{ cab.CabCode }}</td>
                                <td>{{ cab.MaxCapacity }}</td>
                                <td>{{ cab.Status }}</td>
                                <td class="icon glyphicon glyphicon-trash" ng-click="deleteCab(cab)" title="Delete cab"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel panel-default" ng-show="editMode">
                <!-- Default panel contents -->
                <div class="panel-heading"></div>
                <div class="panel-body">
                    <div id="status-caption" class="alert alert-danger" style="top: 70px; position: absolute; display: none;">{{ $scope.errorMessage }}</div>
                    <form class="form-horizontal" method="post">
                        @Html.ValidationSummary()
                        @Html.HiddenFor(model => model.Id)
                        <div class="form-group">
                            @Html.LabelFor(model => model.CabCode, new { @class = "col-sm-3 control-label" })
                            <div class="col-sm-4">
                                <input type="text" class="form-control" ng-model="cabCode" />
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.LabelFor(model => model.CabDesc, new { @class = "col-sm-3 control-label" })
                            <div class="col-sm-4">
                                <textarea class="form-control" ng-model="cabDesc"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.LabelFor(model => model.MaxCapacity, new { @class = "col-sm-3 control-label" })
                            <div class="col-sm-4">
                                <input type="number" class="form-control" ng-model="maxCapacity" />
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-3">
                            </div>
                            <div class="col-sm-6">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" ng-model="onDutyStatus" />@Html.DisplayNameFor(model => model.OnDutyStatus)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-offset-3 col-sm-2">
                            <button type="button" ng-click="saveCab()">Save</button>
                            <button type="reset" ng-click="discardChanges()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
    </div>
</div>

@section ViewScripts{
    <script type="text/ng-template" id="delete-dialog">
        <div class="ngdialog-message">
            <h3>Delete Cab</h3>
            <p>Cab <span style="font-weight: bold;">{{ cabSelected.cabCode }}</span> will be removed permanently.</p>
            <p>Are you sure you want to do this?</p>
        </div>
        <div class="ngdialog-buttons">
            <button type="button" class="ngdialog-button ngdialog-button-primary" ng-click="confirm()">Confirm</button>
            <button type="button" class="ngdialog-button ngdialog-button-secondary" ng-click="closeThisDialog()">Cancel</button>
        </div>
    </script>
    <script type="text/javascript">
        (function (angular) {
            'use strict';
            var app = angular.module('CometCabs', ['ngRoute', 'ngDialog']);

            app.config(['ngDialogProvider', function (ngDialogProvider) {
                ngDialogProvider.setDefaults({
                    className: 'ngdialog-theme-default',
                    plain: false,
                    showClose: true,
                    closeByDocument: true,
                    closeByEscape: true,
                    appendTo: false,
                    preCloseCallback: function () {
                        console.log('default pre-close callback');
                    }
                });
            }]);

            // TODO: add user
            // TODO: edit user
            // TODO: delete user

            app.controller('CabController', ['$scope', '$http', '$route', '$timeout', 'ngDialog', function ($scope, $http, $route, $timeout, ngDialog) {
                $scope.cabTable = JSON.parse($('#cabTable').html());
                $scope.editMode = false;
                $scope.cabCode = '';
                $scope.cabDesc = '';
                $scope.maxCapacity = 0;
                $scope.onDutyStatus = true;
                
                $scope.saveCab = function () {
                    var cab = {
                        cabCode: $scope.cabCode,
                        cabDesc: $scope.cabDesc,
                        maxCapacity: $scope.maxCapacity,
                        emailAddress: $scope.emailAddress,
                        onDutyStatus: $scope.onDutyStatus,
                    }

                    $http({ method: 'POST', url: '/Cabs/SaveCab', contentType: 'application/json', data: cab })
                        .success(function (data) {
                            // resetMap();
                            if (data === '') {
                                location.href = '/Cabs/Index'
                            } else {
                                $timeout(function () {
                                    angular.element('#status-caption').fadeToggle(1000);
                                }, 5000);
                            }
                        })
                        .error(function (data, status, headers, config) {
                            // called asynchronously if an error occurs
                            // or server returns response with an error status.
                            console.log(data + ' ' + status + ' ' + headers + ' ' + config)
                        });
                };

                $scope.discardChanges = function () {
                    clearForm()
                };

                $scope.addCab = function () {
                    $scope.editMode = true;
                };

                $scope.editUser = function () {

                };

                function clearForm() {
                    $scope.editMode = false;
                    $scope.cabCode = '';
                    $scope.cabDesc = '';
                    $scope.maxCapacity = 0;
                    $scope.onDutyStatus = true;
                }
            }]);
        })(window.angular);
    </script>
}